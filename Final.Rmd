---
title: "Final Project"
author: "Yikun Zhou"
date: "November 27, 2014"
output: html_document
---

# Exploring data
```{r}
library(gam)
library(MASS)
library(car)
library(ISLR)
library(leaps)
library(glmnet)
data <- read.table("costs.txt",header=T)
data <- data[1:8]


panel.hist <- function(x, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5) )
    h <- hist(x, plot = FALSE)
    breaks <- h$breaks; nB <- length(breaks)
    y <- h$counts; y <- y/max(y)
    rect(breaks[-nB], 0, breaks[-1], y, col = "cyan", ...)
}

panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- abs(cor(x, y))
    txt <- format(c(r, 0.123456789), digits = digits)[1]
    txt <- paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
    text(0.5, 0.5, txt, cex = cex.cor * r)
}

pairs(data,lower.panel = panel.smooth, upper.panel = panel.cor, diag.panel = panel.hist)
```
It seems that there exist non-linearity in variable RXPM. Colinearity in Copay, RI and Age. Also, MM seem to be a much larger scale of data than others, so we can take logrithm to it.

detect colinearity
```{r}
lm.1 <- lm(COST~.,data)
vif(lm.1)

lm.2 <- lm(COST~ RXPM + GS + RI + AGE + F + MM,data=data)
summary(lm.1)
summary(lm.2)
```
RI and COPAY may have colinearity exists.

detect outliers
```{r}
par(mfrow=c(2,2))
plot(lm.1)
```
from leverage plot we see that point 19 might have high influence to the model

??try to leave out point 19
```{r}
data1 <- data[-19,]
lm.11 <- lm(COST~.,data1)
plot(lm.11)
summary(lm.11)
summary(lm.1)
```

try BMA
```{r}
library(BMA)

BMA <- MC3.REG(all.y = data$COST, 
        all.x = matrix(c(data$RXPM,data$GS,data$RI,data$COPAY,data$AGE,data$F,log(data$MM)),nrow=29),
        num.its = 10000, outliers = TRUE)
summary(BMA)
par(mfrow=c(1,1))
image(BMA)
```



log MM
```{r}
lm.2 <- lm(COST~ RXPM + GS + RI + COPAY + AGE + F + log(MM),data=data)
anova(lm.1,lm.2)
```
It is significant to do logrithm to MM

try gam
```{r}
gam.1 <- gam(COST ~ poly(RXPM,3) + GS + RI + COPAY + AGE + F + log(MM),data=data)
summary(gam.1)
anova(lm.1,lm.2,gam.1)
```



try interaction
```{r}
lm.3 <- lm(COST~ RXPM + GS + RI + COPAY + AGE + F + log(MM) ,
           data=data)
vif(lm.3)
summary(lm.3)

anova(lm.1,lm.2,lm.3)
```

LASSO
```{r}
data[,8] <- log(data[,8])
data <- data[-19,]
data <- data[,-5]
y <- data[,1]
x <- as.matrix(data[,2:7])
train=sample(1:nrow(x), nrow(x)-9)
test=(-train)

grid=10^seq(10,-3,length=100)
lasso.mod <- glmnet(x[train,],y[train],alpha=1)
plot(lasso.mod)

cv.out <- cv.glmnet(x[train,],y[train],alpha=1)
plot(cv.out)
bestlam <- cv.out$lambda.min

out <- glmnet(x,y,alpha=1,lambda=grid)
lasso.coef = predict(out,type="coefficients",s=bestlam)
lasso.coef
```

```{r}
regfit.full=regsubsets(COST~.,data)
reg.summary<-summary(regfit.full)
reg.summary$rsq
par(mfrow=c(2,2))
plot(reg.summary$rss ,xlab="Number of Variables ",ylab="RSS",
type="l")
plot(reg.summary$adjr2 ,xlab="Number of Variables ",
ylab="Adjusted RSq",type="l")
plot(reg.summary$cp ,xlab="Number of Variables ",ylab="Cp", type='l')

points(which.min(reg.summary$cp ),reg.summary$cp [which.min(reg.summary$cp )],col="red",cex=2,pch=20)
plot(reg.summary$bic ,xlab="Number of Variables ",ylab="BIC",type='l')

points(which.min(reg.summary$bic ),reg.summary$bic [which.min(reg.summary$bic )],col="red",cex=2,pch=20)

plot(regfit.full,scale="r2")
plot(regfit.full,scale="adjr2") 
plot(regfit.full,scale="Cp")
 plot(regfit.full,scale="bic")

coef(regfit.full ,2)
```


