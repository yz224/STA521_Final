---
title: "Final Project"
author: "Yikun Zhou"
date: "November 27, 2014"
output: html_document
---

# Exploring data
```{r}
library(gam)
library(MASS)
library(car)
library(ISLR)
library(leaps)
library(glmnet)
data <- read.table("costs.txt",header=T)
data <- data[1:8]


panel.hist <- function(x, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5) )
    h <- hist(x, plot = FALSE)
    breaks <- h$breaks; nB <- length(breaks)
    y <- h$counts; y <- y/max(y)
    rect(breaks[-nB], 0, breaks[-1], y, col = "cyan", ...)
}

panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- abs(cor(x, y))
    txt <- format(c(r, 0.123456789), digits = digits)[1]
    txt <- paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
    text(0.5, 0.5, txt, cex = cex.cor * r)
}

pairs(data,lower.panel = panel.smooth, upper.panel = panel.cor, diag.panel = panel.hist)

lm.1 <- lm(COST~.,data)
plot(lm.1)
```

From the histogram of each variable in the diagonal, we can see that some varialbes don't follow normal distribution. We want to find out the best transformation of each variable.

From plot of full linear model, there may exist influential outliers (19) that has cook's distance > 1

From the correlation matrix, there may exist colinearity between Copay and RI

Using unconditional box cox transformations for independent variable. Then, transform response accordingly. 

```{r}
p1 <- powerTransform(data)
summary(p1)
coef(p1,round=T)
test=data
test$GS=test$GS^2
test$RI=sqrt(test$RI)
test$COPAY=log(test$COPAY)
test$MM=sqrt(test$MM)
p11 <- powerTransform(test)
p2 <-powerTransform(lm(COST~., test))
summary(p11)
summary(p2)
coef(p11,round=T)
coef(p2,round=T)
pairs(test,lower.panel = panel.smooth, upper.panel = panel.cor, diag.panel = panel.hist)
```

detect colinearity
```{r}
lm.2 <- lm(COST~.,data=test)
summary(lm.2)
vif(lm.2)
```
no colinearity exists

detect outliers
```{r}
par(mfrow=c(2,2))
plot(lm.1)
```
After transformation, although there are some outliers, there is no observations being influential (all cook's distance < 0.5). 

try BMA
```{r}
library(BMA)

BMA <- MC3.REG(all.y = test$COST, 
        all.x = matrix(c(test$RXPM,test$GS,test$RI,test$COPAY,test$AGE,test$F,log(test$MM)),nrow=29),
        num.its = 10000, outliers = TRUE)
summary(BMA)
```
More certain that no outliers.

try gam
```{r}
gam.1 <- gam(COST ~ RXPM + GS + s(RI,2) + COPAY + AGE + F + MM,data=test)
summary(gam.1)
anova(lm.1,lm.2,gam.1)
```

try interaction
```{r}
lm.3 <- lm(COST~ RXPM + GS + RI + COPAY + AGE + F + MM ,
           data=test)
vif(lm.3)
summary(lm.3)

anova(lm.1,lm.2,lm.3)
```

LASSO
```{r}
y <- test[,1]
x <- as.matrix(test[,2:8])
train=sample(1:nrow(x), nrow(x)-9)

grid=10^seq(10,-2,length=100)
lasso.mod <- glmnet(x[train,],y[train],alpha=1)
plot(lasso.mod)

cv.out <- cv.glmnet(x[train,],y[train],alpha=1)
plot(cv.out)
bestlam <- cv.out$lambda.min

out <- glmnet(x,y,alpha=1,lambda=grid)
lasso.coef = predict(out,type="coefficients",s=bestlam)
lasso.coef
```

```{r}
regfit.full=regsubsets(COST~.,test)
reg.summary<-summary(regfit.full)
reg.summary$rsq
par(mfrow=c(2,2))
plot(reg.summary$rss ,xlab="Number of Variables ",ylab="RSS",
type="l")
plot(reg.summary$adjr2 ,xlab="Number of Variables ",
ylab="Adjusted RSq",type="l")
plot(reg.summary$cp ,xlab="Number of Variables ",ylab="Cp", type='l')

points(which.min(reg.summary$cp ),reg.summary$cp [which.min(reg.summary$cp )],col="red",cex=2,pch=20)
plot(reg.summary$bic ,xlab="Number of Variables ",ylab="BIC",type='l')

points(which.min(reg.summary$bic ),reg.summary$bic [which.min(reg.summary$bic )],col="red",cex=2,pch=20)

plot(regfit.full,scale="r2")
plot(regfit.full,scale="adjr2") 
plot(regfit.full,scale="Cp")
 plot(regfit.full,scale="bic")

coef(regfit.full ,3)
```


```{r}
par(mfrow=c(1,1))
lapply(1:8,function(x) hist(data[,x], main=names(data)[x],xlab=names(data)[x]))
```



